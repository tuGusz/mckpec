<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Monitoramento MCK</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        body { background-color: #f0f2f5; }
        .card-status { border-left: 5px solid gray; transition: transform 0.2s;}
        .card-status:hover { transform: translateY(-5px); }
        .status-Online { border-left-color: #198754; } 
        .status-Erro { border-left-color: #dc3545; }   
        .status-Offline { border-left-color: #6c757d; opacity: 0.8; } 
        .badge-servico { font-size: 0.85em; margin-right: 5px; margin-bottom: 5px; display: inline-block; }
        .hardware-info { font-size: 0.75rem; color: #555; }
        .btn-acao { font-size: 0.75rem; margin-bottom: 5px; width: 100%; text-align: left; }
    </style>
</head>
<body>

<nav class="navbar navbar-dark bg-dark mb-4">
    <div class="container-fluid">
        <span class="navbar-brand mb-0 h1">MCK Monitoramento - PEC</span>
        <span class="text-white" style="font-size: 0.8rem" id="relogio">Atualizado: --:--:--</span>
    </div>
</nav>

<div class="container">
    <div class="row" id="painel-clientes">
        <div class="col-12 text-center">
            <div class="spinner-border text-primary" role="status"></div>
            <p>Carregando dados dos municípios...</p>
        </div>
    </div>
</div>

<script>
    const URL_BANCO = "https://monitorpec-72985-default-rtdb.firebaseio.com/clientes";

    async function enviarComando(municipio, comando) {
        if(!confirm(`Deseja enviar o comando: "${comando}" para ${municipio}?`)) return;

        const urlComando = `${URL_BANCO}/${municipio}/comando.json`;
        
        try {
            await fetch(urlComando, {
                method: 'PUT',
                body: JSON.stringify(comando)
            });
            alert("Comando enviado! Aguarde a execução.");
        } catch (error) {
            alert("Erro ao enviar comando: " + error);
        }
    }

    function parseDataPTBR(dataStr) {
        if(!dataStr) return new Date(0);
        const [dateValues, timeValues] = dataStr.split(' ');
        const [day, month, year] = dateValues.split('/');
        const [hours, minutes, seconds] = timeValues.split(':');
        return new Date(+year, +month - 1, +day, +hours, +minutes, +seconds);
    }

    async function atualizarPainel() {
        try {
            document.getElementById('relogio').innerText = "Verificando: " + new Date().toLocaleTimeString();
            
            const resposta = await fetch(URL_BANCO + ".json");
            const dados = await resposta.json();
             
            const container = document.getElementById('painel-clientes');
            container.innerHTML = '';  

            if (!dados) {
                container.innerHTML = '<div class="alert alert-warning">Nenhum dado encontrado no servidor.</div>';
                return;
            }

            const agora = new Date();

            for (let municipio in dados) {
                let info = dados[municipio];
             
                let dataUltimaAtualizacao = parseDataPTBR(info.ultima_atualizacao);
                let diferencaSegundos = (agora - dataUltimaAtualizacao) / 1000;
                let agenteStatus = "Agente Online";
                let badgeAgente = "bg-success";
                
                if (diferencaSegundos > 120) {
                    agenteStatus = "Agente Parado/Offline";
                    badgeAgente = "bg-secondary";
                }
 
                let bordaClass = info.status_geral === 'Online' ? 'status-Online' : 'status-Erro';
                let textoStatusGeral = info.status_geral === 'Online' ? 'ONLINE' : 'ERRO';
                let corStatusGeral = info.status_geral === 'Online' ? 'success' : 'danger';

                if (agenteStatus !== "Agente Online") {
                    bordaClass = "status-Offline";
                    textoStatusGeral = "OFFLINE";
                    corStatusGeral = "secondary";
                }

                
                let listaErros = info.erros || []; 
                let isPgOff = listaErros.includes("PostgreSQL OFF");
                let isPecOff = listaErros.includes("PEC OFF");
                let isGatewayOff = listaErros.includes("Gateway OFF");

               
                let htmlPostgres = isPgOff
                    ? `<span class="badge bg-danger badge-servico"><i class="bi bi-x-circle"></i> PostgreSQL OFF</span>`
                    : `<span class="badge bg-success badge-servico"><i class="bi bi-check-circle"></i> PostgreSQL OK</span>`;

                let htmlPEC = isPecOff
                    ? `<span class="badge bg-danger badge-servico"><i class="bi bi-x-circle"></i> e-SUS PEC OFF</span>`
                    : `<span class="badge bg-success badge-servico"><i class="bi bi-check-circle"></i> e-SUS PEC OK</span>`;

                let htmlGateway = isGatewayOff
                    ? `<span class="badge bg-danger badge-servico"><i class="bi bi-x-circle"></i> Gateway OFF</span>`
                    : `<span class="badge bg-success badge-servico"><i class="bi bi-check-circle"></i> Gateway OK</span>`;

                 
                let btnPec = '';
                if (isPecOff) {
                 
                    btnPec = `<button class="btn btn-outline-success btn-sm btn-acao" onclick="enviarComando('${municipio}', 'start_esus')">
                                <i class="bi bi-play-circle"></i> Iniciar e-SUS
                              </button>`;
                } else {
                     
                    btnPec = `<button class="btn btn-outline-danger btn-sm btn-acao" onclick="enviarComando('${municipio}', 'stop_esus')">
                                <i class="bi bi-stop-circle"></i> Parar e-SUS
                              </button>
                              <button class="btn btn-outline-warning btn-sm btn-acao" onclick="enviarComando('${municipio}', 'restart_esus')">
                                <i class="bi bi-arrow-clockwise"></i> Reiniciar e-SUS
                              </button>`;
                }

                let btnPg = '';
                if (isPgOff) {
                    btnPg = `<button class="btn btn-outline-success btn-sm btn-acao" onclick="enviarComando('${municipio}', 'start_pg')">
                                <i class="bi bi-play-circle"></i> Iniciar PGSQL
                             </button>`;
                } else {
                    btnPg = `<button class="btn btn-outline-danger btn-sm btn-acao" onclick="enviarComando('${municipio}', 'stop_pg')">
                                <i class="bi bi-database-dash"></i> Parar PGSQL
                             </button>
                             <button class="btn btn-outline-warning btn-sm btn-acao" onclick="enviarComando('${municipio}', 'restart_pg')">
                                <i class="bi bi-arrow-repeat"></i> Reiniciar PGSQL
                             </button>`;
                }

              
                let htmlBotoes = '';
                if (agenteStatus === "Agente Online") {
                    htmlBotoes = `
                        <div class="mt-3 pt-2 border-top">
                            <h6 class="text-muted" style="font-size: 0.8rem">Ações de Controle:</h6>
                            <div class="row g-1">
                                <div class="col-6">
                                    ${btnPec}
                                </div>
                                <div class="col-6">
                                    ${btnPg}
                                </div>
                                <div class="col-12">
                                    <button class="btn btn-outline-primary btn-sm btn-acao" onclick="enviarComando('${municipio}', 'update_pec')">
                                        <i class="bi bi-cloud-arrow-down"></i> Atualizar PEC (v5.X)
                                    </button>
                                    <button class="btn btn-outline-info btn-sm btn-acao" onclick="enviarComando('${municipio}', 'open_gateway')">
                                        <i class="bi bi-window-stack"></i> Abrir Gateway PowerBI
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                }

                let html = `
                    <div class="col-md-4 mb-4">
                        <div class="card shadow-sm card-status ${bordaClass}">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <h5 class="card-title m-0">${municipio}</h5>
                                    <span class="badge bg-${corStatusGeral}">${textoStatusGeral}</span>
                                </div>
                                
                                <span class="badge ${badgeAgente}" style="font-size:0.7rem">
                                    <i class="bi bi-robot"></i> ${agenteStatus}
                                </span>

                                <h6 class="card-subtitle my-2 text-muted" style="font-size: 0.8rem">
                                    <i class="bi bi-pc-display"></i> ${info.maquina || 'PC Desconhecido'}
                                </h6>
                                
                                <div class="my-2">
                                    ${htmlPostgres} ${htmlPEC} ${htmlGateway}
                                </div>

                                <div class="alert alert-light border p-2 hardware-info mb-0">
                                    <div class="mb-1 border-bottom pb-1">
                                        <i class="bi bi-clock"></i> <strong>Última atualização:</strong><br> ${info.ultima_atualizacao}
                                    </div>
                                    <div class="mt-1">
                                        <strong>OS:</strong> ${info.hardware.sistema || '?'}<br>
                                        <strong>CPU:</strong> ${info.hardware.processador || '?'}<br>
                                        <strong>RAM:</strong> ${info.hardware.memoria_ram || '?'} | 
                                        <strong>Disco:</strong> ${info.hardware.armazenamento || '?'}
                                    </div>
                                </div>

                                ${htmlBotoes}
                            </div>
                        </div>
                    </div>
                `;
                container.innerHTML += html;
            }

        } catch (erro) {
            console.error(erro);
        }
    }

    atualizarPainel();
    setInterval(atualizarPainel, 5000);

</script>
</body>
</html>
